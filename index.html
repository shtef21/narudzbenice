<!DOCTYPE html>
<html lang="hr">
<head>
  <meta charset="UTF-8">
  <title>Generiranje narud≈æbenice</title>
  <link href="./bootstrap.css" rel="stylesheet">
</head>
<body class="bg-light">
  <main class="container my-4 p-4 bg-white rounded shadow-sm">
    <h1 class="mb-4">Generiranje narud≈æbenice</h1>

    <!-- Buyer -->
    <div class="mb-3">
      <label for="buyer-oib" class="form-label">Kupac</label>
      <div class="input-group mb-2">
        <input type="text" class="form-control" id="buyer-oib" placeholder="Unesite OIB kupca" value="84214771175">
        <button class="btn btn-outline-info" type="button" id="fetch-buyer">
          üì•
        </button>
      </div>
      <input type="text" class="form-control" id="buyer-name" placeholder="Unesite naziv kupca">
    </div>

    <!-- Supplier -->
    <div class="mb-3">
      <label for="supplier-oib" class="form-label">Dobavljaƒç</label>
      <div class="input-group mb-2">
        <input type="text" class="form-control" id="supplier-oib" placeholder="Unesite OIB dobavljaƒça" value="29756659895">
        <button class="btn btn-outline-info" type="button" id="fetch-supplier">
          üì•
        </button>
      </div>
      <input type="text" class="form-control" id="supplier-name" placeholder="Unesite naziv dobavljaƒça">
    </div>


    <!-- Items container -->
    <div id="items-container">
    </div>

    <div class="d-flex gap-2 mb-3">
      <button type="button" id="add-item" class="btn btn-primary">Dodaj stavku</button>
      <button type="button" id="remove-item" class="btn btn-danger">Ukloni posljednju stavku</button>
      <button type="button" id="generate_text" class="btn btn-success">Generiraj tekst</button>
      <button type="button" id="generate_pdf" class="btn btn-success">Generiraj PDF</button>
    </div>

    <pre id="output" class="p-3 border bg-light rounded"></pre>
  </main>

  <script src="./bootstrap.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.10/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.10/vfs_fonts.js"></script>
  <script>
    const currency = "EUR";
    const itemsContainer = document.getElementById("items-container");
    let itemCounter = 0;

    // Add new item row
    document.getElementById("add-item").addEventListener("click", function() {
      const itemRow = document.createElement("div");
      itemRow.classList.add("border", "p-3", "mb-3", "rounded", "bg-light-subtle");
      itemRow.innerHTML = `
        <div class="mb-2">
          <label class="form-label">Stavka ${++itemCounter} (Proizvod/Usluga)</label>
          <input type="text" class="form-control item-name" placeholder="Naziv proizvoda ili usluge">
        </div>
        <div class="mb-2">
          <label class="form-label">Koliƒçina</label>
          <input type="number" class="form-control item-qty" placeholder="Unesite koliƒçinu">
        </div>
        <div>
          <label class="form-label">Jediniƒçna cijena (${currency})</label>
          <input type="number" class="form-control item-price" step="0.01" placeholder="Unesite cijenu">
        </div>
      `;
      itemsContainer.appendChild(itemRow);
    });
    
    // Remove last item row
    document.getElementById("remove-item").addEventListener("click", function() {
      const itemsContainer = document.getElementById("items-container");
      if (itemsContainer.lastElementChild) {
        itemsContainer.removeChild(itemsContainer.lastElementChild);
        --itemCounter;
      } else {
        alert("Nema stavki za izbrisati.");
      }
    });

    // Function used for fetching data by oib
    function fetchDataByOib(oib, destEl) {
      return fetch(`/dohvati-podatke?oib=${oib}`)
        .then(res => res.json())
        .then(data => document.getElementById(destEl).value = data.name)
        .catch(console.log)
    }

    // Fetch buyer by OIB (example)
    document.getElementById("fetch-buyer").addEventListener("click", function() {
      const oib = document.getElementById("buyer-oib").value.trim();
      if (!oib) { alert("Unesite OIB kupca."); return; }

      fetchDataByOib(oib, "buyer-name");
    });

    // Fetch supplier by OIB (example)
    document.getElementById("fetch-supplier").addEventListener("click", function() {
      const oib = document.getElementById("supplier-oib").value.trim();
      if (!oib) { alert("Unesite OIB dobavljaƒça."); return; }
      
      fetchDataByOib(oib, "supplier-name");
    });

    // Get form data
    function getFormData() {
      const buyerOIB = document.getElementById("buyer-oib").value.trim();
      const buyerName = document.getElementById("buyer-name").value.trim();
      const supplierOIB = document.getElementById("supplier-oib").value.trim();
      const supplierName = document.getElementById("supplier-name").value.trim();

      const names = document.querySelectorAll(".item-name");
      const qtys = document.querySelectorAll(".item-qty");
      const prices = document.querySelectorAll(".item-price");
      const items = names.length === 0 ? [] : [...names].map((_, idx) => {
        const name = names[idx].value.trim();
        const quantity = parseFloat(qtys[idx].value);
        const price = parseFloat(prices[idx].value);
        const total = quantity * price;
        return { name, quantity, price, total };
      }).filter((item) => item.name || item.quantity || item.price || item.total);
      const grandTotal = items.reduce((sum, item) => sum + item.total, 0);
      return {
        buyerOIB,
        buyerName,
        supplierOIB,
        supplierName,
        items,
        grandTotal,
        created: new Date(),
        createdStr: new Date().toLocaleDateString("hr-HR"),
      };
    }

    // Validate data of the form
    function validateFormData(formData) {
      if (!formData.buyerOIB || !formData.buyerName || !formData.supplierOIB || !formData.supplierName) {
        alert("Molimo unesite OIB i naziv kupca/dobavljaƒça.");
        return false;
      }
      if (formData.items.length === 0) {
        alert("Molimo unesite barem 1 stavku pritiskom na gumb 'Dodaj stavku'.");
        return false;
      }
      for (let i = 0; i < formData.items.length; i++) {
        let item = formData.items[i];
        if (!item.name || isNaN(item.quantity) || isNaN(item.price)) {
          alert("Molimo unesite sve podatke stavke broj " + (i+1) + ".");
          return false;
        }
      }
    }

    // Generate text
    document.getElementById("generate_text").addEventListener("click", function() {
      const formData = getFormData();

      if (validateFormData(formData) === false) {
        console.log('User did not fill entire form correctly.');
        return;
      }

      // Create output text
      let orderText = `NARUD≈ΩBENICA\nKupac: ${formData.buyerName} (OIB: ${formData.buyerOIB})\nDobavljaƒç: ${formData.supplierName} (OIB: ${formData.supplierOIB})\n\nSTAVKE:\n`;
      for (let item of formData.items) {
        orderText += `- ${item.name} | ${item.quantity} kom | ${item.price.toFixed(2)} ${currency} | Ukupno: ${item.total.toFixed(2)} ${currency}\n`;
      }
      orderText += `\nUKUPNO ZA PLATITI: ${formData.grandTotal.toFixed(2)} ${currency}\nDatum: ${formData.createdStr}`;

      document.getElementById("output").textContent = orderText;
    });

    // Generate PDF
    document.getElementById("generate_pdf").addEventListener("click", () => {
      const formData = getFormData();

      if (validateFormData(formData) === false) {
        console.log('User did not fill entire form correctly.');
        return;
      }

      const docDefinition = {
        content: [
          { text: 'Narud≈æbenica', style: 'mainHeader', alignment: 'center' },
          { text: 'Kupac', style: 'header' },
          { text: 'OIB: ' + formData.buyerOIB },
          { text: 'Naziv: ' + formData.buyerName },
          { text: '\n' },
          { text: 'Dobavljaƒç', style: 'header' },
          { text: 'OIB: ' + formData.supplierOIB },
          { text: 'Naziv: ' + formData.supplierName },
          { text: '\n' },
          { text: 'Broj stavki: ' + formData.items.length + '\nUkupna cijena (EUR): ' + formData.grandTotal },
          { text: 'Stavke:', style: 'subheader' },
          {
            table: {
              headerRows: 1,
              widths: ['*', 'auto', 100, '*'],
              body: [
                [
                  { text: 'Naziv', bold: true },
                  { text: 'Koliƒçina', bold: true },
                  { text: 'Cijena (EUR)', bold: true },
                  { text: 'Ukupno (EUR)', bold: true }
                ],
                ...formData.items.map((item) => 
                  [item.name, item.quantity, item.price.toFixed(2), item.total.toFixed(2)]
                )
              ]
            }
          },
          { text: '\n Generirano ' + formData.createdStr }
        ],
        styles: {
          mainHeader: {
            fontSize: 22,
            bold: true,
            margin: [0, 0, 0, 20]
          },
          header: {
            fontSize: 18,
            bold: true,
            margin: [0, 0, 0, 10]
          },
          subheader: {
            fontSize: 14,
            bold: true,
            margin: [0, 10, 0, 5]
          }
        }
      };

      pdfMake.createPdf(docDefinition).download('Narudzbenica-' + formData.supplierOIB + '.pdf');
    })
  </script>
</body>
</html>
